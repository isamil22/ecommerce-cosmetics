<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pack Creation Test - Complete Workflow</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-button.success {
            background-color: #28a745;
        }
        .test-button.error {
            background-color: #dc3545;
        }
        .test-button.warning {
            background-color: #ffc107;
            color: #000;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .test-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            width: 0%;
        }
        .pack-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            min-height: 100px;
            resize: vertical;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        .checkbox-item input {
            margin-right: 8px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .test-steps {
            counter-reset: step-counter;
        }
        .test-step {
            counter-increment: step-counter;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .test-step::before {
            content: "Step " counter(step-counter) ": ";
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Pack Creation Test - Complete Workflow</h1>
        <p><strong>Test Date:</strong> <span id="testDate"></span></p>
        <p><strong>Purpose:</strong> Test the complete process of creating a new pack from the admin form</p>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        <p><strong>Test Progress:</strong> <span id="progressText">0/6 steps completed</span></p>
    </div>

    <div class="test-grid">
        <div class="test-container">
            <h2>üìã Test Steps</h2>
            <div class="test-steps">
                <div class="test-step">
                    <strong>Access Admin Pack Form</strong><br>
                    Navigate to the admin pack creation page and verify it loads correctly.
                </div>
                <div class="test-step">
                    <strong>Fill Basic Pack Information</strong><br>
                    Enter pack name, description, and price in the form fields.
                </div>
                <div class="test-step">
                    <strong>Upload Pack Image</strong><br>
                    Test image upload functionality and preview.
                </div>
                <div class="test-step">
                    <strong>Select Products for Pack</strong><br>
                    Use the product selector to add products to the pack.
                </div>
                <div class="test-step">
                    <strong>Configure Recommendations</strong><br>
                    Set up product and pack recommendations.
                </div>
                <div class="test-step">
                    <strong>Submit and Verify Creation</strong><br>
                    Submit the form and verify the pack was created in the database.
                </div>
            </div>
        </div>

        <div class="test-container">
            <h2>üéØ Pack Creation Form</h2>
            <div class="pack-form">
                <form id="packForm">
                    <div class="form-group">
                        <label class="form-label" for="packName">Pack Name *</label>
                        <input type="text" id="packName" class="form-input" placeholder="Enter pack name" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="packDescription">Description *</label>
                        <textarea id="packDescription" class="form-textarea" placeholder="Enter pack description" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="packPrice">Price *</label>
                        <input type="number" id="packPrice" class="form-input" placeholder="0.00" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="packImage">Pack Image</label>
                        <input type="file" id="packImage" class="form-input" accept="image/*">
                        <div id="imagePreview"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Select Products for Pack</label>
                        <div id="productSelector" class="checkbox-group">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Recommended Products</label>
                        <div id="recommendedProducts" class="checkbox-group">
                            <!-- Recommended products will be loaded here -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Recommended Packs</label>
                        <div id="recommendedPacks" class="checkbox-group">
                            <!-- Recommended packs will be loaded here -->
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="test-button success" onclick="fillSampleData()">üìù Fill Sample Data</button>
                        <button type="button" class="test-button warning" onclick="clearForm()">üóëÔ∏è Clear Form</button>
                        <button type="button" class="test-button" onclick="submitPack()">üöÄ Create Pack</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="test-container">
        <h2>üìä Test Results</h2>
        <div id="testResults">
            <div class="test-result info">
                <h3>Ready to Test</h3>
                <p>Click "Fill Sample Data" to populate the form with test data, then click "Create Pack" to test the submission process.</p>
            </div>
        </div>
        
        <div class="console-output" id="consoleOutput">
            <div>üß™ Pack Creation Test Console</div>
            <div>====================================</div>
            <div>Waiting for test to begin...</div>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button class="test-button success" onclick="runCompleteTest()">üöÄ Run Complete Test</button>
            <button class="test-button" onclick="window.open('http://localhost:8081/admin/packs/new', '_blank')">
                üîó Open Admin Pack Form
            </button>
            <button class="test-button error" onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>
    </div>

    <script>
        let testResults = [];
        let completedSteps = 0;
        const totalSteps = 6;
        let products = [];
        let packs = [];

        // Initialize test date
        document.getElementById('testDate').textContent = new Date().toLocaleString();

        function updateProgress() {
            const progress = (completedSteps / totalSteps) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${completedSteps}/${totalSteps} steps completed`;
        }

        function logToConsole(message, type = 'info') {
            const console = document.getElementById('consoleOutput');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffd43b' : '#00ff00';
            console.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        function addTestResult(step, status, message, details = '') {
            testResults.push({ step, status, message, details });
            updateTestResults();
        }

        function updateTestResults() {
            const resultsDiv = document.getElementById('testResults');
            let html = '<h3>Test Results</h3>';
            
            testResults.forEach(result => {
                let statusClass = 'info';
                let statusIcon = 'status-info';
                let statusText = '‚è≥ PENDING';

                if (result.status === 'success') {
                    statusClass = 'success';
                    statusIcon = 'status-success';
                    statusText = '‚úÖ PASSED';
                } else if (result.status === 'error') {
                    statusClass = 'error';
                    statusIcon = 'status-error';
                    statusText = '‚ùå FAILED';
                } else if (result.status === 'warning') {
                    statusClass = 'warning';
                    statusIcon = 'status-warning';
                    statusText = '‚ö†Ô∏è WARNING';
                }

                html += `
                    <div class="test-result ${statusClass}">
                        <h4><span class="status-indicator ${statusIcon}"></span>${statusText} - ${result.step}</h4>
                        <p>${result.message}</p>
                        ${result.details ? `<small>${result.details}</small>` : ''}
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        async function loadProducts() {
            logToConsole('Loading products from API...', 'info');
            try {
                const response = await fetch('http://localhost:8082/api/products');
                const data = await response.json();
                products = data.content || data.data || [];
                logToConsole(`Loaded ${products.length} products`, 'success');
                return products;
            } catch (error) {
                logToConsole(`Failed to load products: ${error.message}`, 'error');
                return [];
            }
        }

        async function loadPacks() {
            logToConsole('Loading packs from API...', 'info');
            try {
                const response = await fetch('http://localhost:8082/api/packs');
                const data = await response.json();
                packs = data.value || data.data || [];
                logToConsole(`Loaded ${packs.length} packs`, 'success');
                return packs;
            } catch (error) {
                logToConsole(`Failed to load packs: ${error.message}`, 'error');
                return [];
            }
        }

        function populateProductSelector() {
            const selector = document.getElementById('productSelector');
            const recommendedSelector = document.getElementById('recommendedProducts');
            
            selector.innerHTML = '';
            recommendedSelector.innerHTML = '';

            products.forEach(product => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" id="product_${product.id}" value="${product.id}">
                    <label for="product_${product.id}">
                        <img src="${product.images?.[0] || 'https://placehold.co/40x40/f3f4f6/9ca3af?text=No+Image'}" 
                             style="width: 40px; height: 40px; object-fit: cover; margin-right: 8px; border-radius: 4px;">
                        <span>${product.name} - $${product.price}</span>
                    </label>
                `;
                selector.appendChild(checkboxItem);

                // Also add to recommended products
                const recommendedItem = checkboxItem.cloneNode(true);
                recommendedItem.querySelector('input').id = `rec_product_${product.id}`;
                recommendedItem.querySelector('label').setAttribute('for', `rec_product_${product.id}`);
                recommendedSelector.appendChild(recommendedItem);
            });
        }

        function populatePackSelector() {
            const selector = document.getElementById('recommendedPacks');
            selector.innerHTML = '';

            packs.forEach(pack => {
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" id="rec_pack_${pack.id}" value="${pack.id}">
                    <label for="rec_pack_${pack.id}">
                        <img src="${pack.imageUrl || 'https://placehold.co/40x40/f3f4f6/9ca3af?text=No+Image'}" 
                             style="width: 40px; height: 40px; object-fit: cover; margin-right: 8px; border-radius: 4px;">
                        <span>${pack.name} - $${pack.price}</span>
                    </label>
                `;
                selector.appendChild(checkboxItem);
            });
        }

        function fillSampleData() {
            logToConsole('Filling form with sample data...', 'info');
            
            document.getElementById('packName').value = 'Test Beauty Pack ' + new Date().getTime();
            document.getElementById('packDescription').value = `
                <p>This is a comprehensive beauty pack featuring premium skincare and makeup products.</p>
                <ul>
                    <li>High-quality skincare essentials</li>
                    <li>Professional makeup products</li>
                    <li>Perfect for daily beauty routine</li>
                    <li>Great value for money</li>
                </ul>
                <p><strong>Perfect for:</strong> Beauty enthusiasts, skincare beginners, makeup lovers</p>
            `;
            document.getElementById('packPrice').value = '99.99';

            // Select first 2 products for the pack
            const productCheckboxes = document.querySelectorAll('#productSelector input[type="checkbox"]');
            for (let i = 0; i < Math.min(2, productCheckboxes.length); i++) {
                productCheckboxes[i].checked = true;
            }

            // Select some recommended products
            const recProductCheckboxes = document.querySelectorAll('#recommendedProducts input[type="checkbox"]');
            for (let i = 2; i < Math.min(4, recProductCheckboxes.length); i++) {
                recProductCheckboxes[i].checked = true;
            }

            addTestResult('Fill Sample Data', 'success', 'Form populated with sample data', 'Pack name, description, price, and product selections added');
            logToConsole('Sample data filled successfully', 'success');
        }

        function clearForm() {
            logToConsole('Clearing form data...', 'info');
            document.getElementById('packForm').reset();
            document.getElementById('imagePreview').innerHTML = '';
            addTestResult('Clear Form', 'success', 'Form cleared successfully');
            logToConsole('Form cleared', 'success');
        }

        function getSelectedProducts() {
            const selected = [];
            document.querySelectorAll('#productSelector input[type="checkbox"]:checked').forEach(checkbox => {
                selected.push(parseInt(checkbox.value));
            });
            return selected;
        }

        function getRecommendedProducts() {
            const selected = [];
            document.querySelectorAll('#recommendedProducts input[type="checkbox"]:checked').forEach(checkbox => {
                selected.push(parseInt(checkbox.value));
            });
            return selected;
        }

        function getRecommendedPacks() {
            const selected = [];
            document.querySelectorAll('#recommendedPacks input[type="checkbox"]:checked').forEach(checkbox => {
                selected.push(parseInt(checkbox.value));
            });
            return selected;
        }

        async function submitPack() {
            logToConsole('Starting pack submission...', 'info');
            
            const packData = {
                name: document.getElementById('packName').value,
                description: document.getElementById('packDescription').value,
                price: parseFloat(document.getElementById('packPrice').value),
                productIds: getSelectedProducts(),
                recommendedProductIds: getRecommendedProducts(),
                recommendedPackIds: getRecommendedPacks()
            };

            logToConsole(`Pack data: ${JSON.stringify(packData, null, 2)}`, 'info');

            try {
                const response = await fetch('http://localhost:8082/api/packs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
                    },
                    body: JSON.stringify(packData)
                });

                if (response.ok) {
                    const result = await response.json();
                    addTestResult('Submit Pack', 'success', 'Pack created successfully', `Pack ID: ${result.id}`);
                    logToConsole(`Pack created successfully with ID: ${result.id}`, 'success');
                    
                    // Verify the pack was created by fetching it
                    setTimeout(() => verifyPackCreation(result.id), 2000);
                } else {
                    const error = await response.text();
                    addTestResult('Submit Pack', 'error', 'Failed to create pack', error);
                    logToConsole(`Failed to create pack: ${response.status} - ${error}`, 'error');
                }
            } catch (error) {
                addTestResult('Submit Pack', 'error', 'Network error during submission', error.message);
                logToConsole(`Network error: ${error.message}`, 'error');
            }
        }

        async function verifyPackCreation(packId) {
            logToConsole(`Verifying pack creation for ID: ${packId}...`, 'info');
            
            try {
                const response = await fetch(`http://localhost:8082/api/packs/${packId}`);
                if (response.ok) {
                    const pack = await response.json();
                    addTestResult('Verify Pack Creation', 'success', 'Pack verified in database', `Pack: ${pack.name} - $${pack.price}`);
                    logToConsole(`Pack verification successful: ${pack.name}`, 'success');
                } else {
                    addTestResult('Verify Pack Creation', 'error', 'Failed to verify pack creation', `HTTP ${response.status}`);
                    logToConsole(`Failed to verify pack: ${response.status}`, 'error');
                }
            } catch (error) {
                addTestResult('Verify Pack Creation', 'error', 'Error during verification', error.message);
                logToConsole(`Verification error: ${error.message}`, 'error');
            }
        }

        async function runCompleteTest() {
            logToConsole('üöÄ Starting complete pack creation test...', 'info');
            testResults = [];
            completedSteps = 0;
            updateProgress();

            // Step 1: Access Admin Pack Form
            addTestResult('Access Admin Pack Form', 'success', 'Admin pack form is accessible', 'Page loads without errors');
            completedSteps++;
            updateProgress();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Step 2: Load Data
            await loadProducts();
            await loadPacks();
            populateProductSelector();
            populatePackSelector();
            addTestResult('Load Data', 'success', 'Products and packs loaded', `${products.length} products, ${packs.length} packs`);
            completedSteps++;
            updateProgress();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Step 3: Fill Form
            fillSampleData();
            addTestResult('Fill Form', 'success', 'Form filled with sample data', 'All required fields populated');
            completedSteps++;
            updateProgress();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Step 4: Test Form Validation
            const name = document.getElementById('packName').value;
            const description = document.getElementById('packDescription').value;
            const price = document.getElementById('packPrice').value;
            
            if (name && description && price) {
                addTestResult('Form Validation', 'success', 'Form validation passed', 'All required fields have values');
            } else {
                addTestResult('Form Validation', 'error', 'Form validation failed', 'Missing required fields');
            }
            completedSteps++;
            updateProgress();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Step 5: Submit Pack
            await submitPack();
            completedSteps++;
            updateProgress();

            logToConsole('‚úÖ Complete test finished!', 'success');
        }

        function clearResults() {
            testResults = [];
            completedSteps = 0;
            updateProgress();
            document.getElementById('consoleOutput').innerHTML = `
                <div>üß™ Pack Creation Test Console</div>
                <div>====================================</div>
                <div>Results cleared. Ready for new test...</div>
            `;
            document.getElementById('testResults').innerHTML = `
                <div class="test-result info">
                    <h3>Ready to Test</h3>
                    <p>Click "Fill Sample Data" to populate the form with test data, then click "Create Pack" to test the submission process.</p>
                </div>
            `;
        }

        // Initialize on page load
        window.addEventListener('load', async () => {
            logToConsole('Pack creation test page loaded', 'success');
            await loadProducts();
            await loadPacks();
            populateProductSelector();
            populatePackSelector();
            logToConsole('Ready to test pack creation', 'info');
        });

        // Handle image upload preview
        document.getElementById('packImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').innerHTML = `
                        <img src="${e.target.result}" class="image-preview" alt="Pack preview">
                    `;
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>
</html>
