<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User vs Guest Coupon Usage Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border-left: 4px solid;
        }
        .success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .critical {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
            font-weight: bold;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .highlight {
            background-color: #fff3cd;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        .step {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
        }
        .user-type {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        .guest-type {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ‘¥ User vs Guest Coupon Usage Test</h1>
        <p>This test verifies that both authenticated users and guest users can apply coupons and that usage counts increase properly for both scenarios.</p>

        <div class="test-section">
            <h2>ðŸ”§ Test Configuration</h2>
            <div class="input-group">
                <label>Admin Email:</label>
                <input type="text" id="adminEmail" value="admin@example.com">
            </div>
            <div class="input-group">
                <label>Admin Password:</label>
                <input type="password" id="adminPassword" value="admin123">
            </div>
            <div class="input-group">
                <label>Test User Email:</label>
                <input type="text" id="userEmail" value="testuser@example.com">
            </div>
            <div class="input-group">
                <label>Test User Password:</label>
                <input type="password" id="userPassword" value="test123">
            </div>
            <div class="input-group">
                <label>Test Coupon Code:</label>
                <input type="text" id="testCouponCode" value="USER_GUEST_TEST_2024">
            </div>
        </div>

        <div class="test-section">
            <h2>ðŸš€ Test Controls</h2>
            <button onclick="runCompleteTest()" id="runTestBtn">ðŸŽ¯ Run Complete Test</button>
            <button onclick="testUserCoupon()" id="userTestBtn">ðŸ‘¤ Test User Coupon</button>
            <button onclick="testGuestCoupon()" id="guestTestBtn">ðŸ‘» Test Guest Coupon</button>
            <button onclick="checkCurrentStatus()" id="checkBtn">ðŸ“Š Check Status</button>
            <button onclick="clearResults()" id="clearBtn">ðŸ§¹ Clear Results</button>
        </div>

        <div class="test-section">
            <h2>ðŸ“‹ Test Results</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        let adminToken = null;
        let userToken = null;
        let testCouponId = null;
        let testProductId = null;
        let initialUsageCount = 0;

        function getAdminEmail() {
            return document.getElementById('adminEmail').value;
        }

        function getAdminPassword() {
            return document.getElementById('adminPassword').value;
        }

        function getUserEmail() {
            return document.getElementById('userEmail').value;
        }

        function getUserPassword() {
            return document.getElementById('userPassword').value;
        }

        function getTestCouponCode() {
            return document.getElementById('testCouponCode').value;
        }

        function log(message, type = 'info', details = '') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${type.toUpperCase()}</strong>\n${message}\n${details}`;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // API Service
        const apiService = {
            baseURL: 'http://localhost:8082/api',
            get: async (url, config = {}) => {
                const fullUrl = `${apiService.baseURL}${url}`;
                const headers = {
                    'Content-Type': 'application/json',
                    ...config.headers
                };
                
                if (adminToken) {
                    headers['Authorization'] = `Bearer ${adminToken}`;
                } else if (userToken) {
                    headers['Authorization'] = `Bearer ${userToken}`;
                }
                
                const response = await fetch(fullUrl, {
                    method: 'GET',
                    headers: headers
                });
                
                const responseData = await response.json();
                
                if (response.ok) {
                    return { data: responseData };
                } else {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(responseData)}`);
                }
            },
            post: async (url, data, config = {}) => {
                const fullUrl = `${apiService.baseURL}${url}`;
                const headers = {
                    'Content-Type': 'application/json',
                    ...config.headers
                };
                
                if (adminToken) {
                    headers['Authorization'] = `Bearer ${adminToken}`;
                } else if (userToken) {
                    headers['Authorization'] = `Bearer ${userToken}`;
                }
                
                const response = await fetch(fullUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data)
                });
                
                const responseData = await response.json();
                
                if (response.ok) {
                    return { data: responseData };
                } else {
                    throw new Error(`HTTP ${response.status}: ${JSON.stringify(responseData)}`);
                }
            }
        };

        async function loginAsAdmin() {
            try {
                log('ðŸ” Logging in as admin...', 'info');
                const response = await apiService.post('/auth/login', {
                    email: getAdminEmail(),
                    password: getAdminPassword()
                });
                adminToken = response.data.token;
                log('âœ… Admin login successful!', 'success');
                return true;
            } catch (error) {
                log(`âŒ Admin login failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function loginAsUser() {
            try {
                log('ðŸ‘¤ Logging in as user...', 'info');
                const response = await apiService.post('/auth/login', {
                    email: getUserEmail(),
                    password: getUserPassword()
                });
                userToken = response.data.token;
                log('âœ… User login successful!', 'success');
                return true;
            } catch (error) {
                log(`âŒ User login failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function createTestCoupon() {
            try {
                log('ðŸŽ« Creating test coupon...', 'info');
                const couponData = {
                    name: 'User vs Guest Test Coupon',
                    code: getTestCouponCode(),
                    discountType: 'PERCENTAGE',
                    discountValue: 20,
                    expiryDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    usageLimit: 10,
                    type: 'USER'
                };

                const response = await apiService.post('/coupons', couponData);
                testCouponId = response.data.id;
                log('âœ… Test coupon created!', 'success', `Coupon ID: ${testCouponId}`);
                return true;
            } catch (error) {
                log(`âŒ Failed to create test coupon: ${error.message}`, 'error');
                return false;
            }
        }

        async function getTestProduct() {
            try {
                log('ðŸ“¦ Getting test product...', 'info');
                const response = await apiService.get('/products?page=0&size=1');
                const products = response.data.content || response.data;
                
                if (products.length === 0) {
                    throw new Error('No products found. Please add some products first.');
                }
                
                testProductId = products[0].id;
                log('âœ… Test product found!', 'success', `Product ID: ${testProductId}, Name: ${products[0].name}`);
                return true;
            } catch (error) {
                log(`âŒ Failed to get test product: ${error.message}`, 'error');
                return false;
            }
        }

        async function getCouponUsage() {
            try {
                const response = await apiService.get('/coupons');
                const coupons = response.data || [];
                const testCoupon = coupons.find(c => c.code === getTestCouponCode());
                
                if (!testCoupon) {
                    throw new Error('Test coupon not found');
                }
                
                return {
                    id: testCoupon.id,
                    timesUsed: testCoupon.timesUsed || 0,
                    usageLimit: testCoupon.usageLimit || 0,
                    details: testCoupon
                };
            } catch (error) {
                throw new Error(`Failed to get coupon usage: ${error.message}`);
            }
        }

        async function testUserCoupon() {
            try {
                log('\nðŸ‘¤ Testing USER coupon application...', 'info');
                
                // Get initial usage
                const beforeData = await getCouponUsage();
                const beforeUsage = beforeData.timesUsed;
                log(`ðŸ“Š Before user test - Usage: ${beforeUsage}`, 'info');

                // Add product to cart
                log('ðŸ“¦ Adding product to user cart...', 'info');
                await apiService.post('/cart/add', {
                    productId: testProductId,
                    quantity: 1
                });

                // Create order with coupon (authenticated user)
                log('ðŸ’³ Creating user order with coupon...', 'info');
                const orderData = {
                    clientFullName: 'Test User',
                    city: 'Test City',
                    address: '123 Test Street',
                    phoneNumber: '1234567890',
                    couponCode: getTestCouponCode()
                };

                const orderResponse = await apiService.post('/orders', orderData);
                log('âœ… User order created!', 'success', `Order ID: ${orderResponse.data.id}`);

                // Wait and check usage
                await new Promise(resolve => setTimeout(resolve, 2000));
                const afterData = await getCouponUsage();
                const afterUsage = afterData.timesUsed;
                const increase = afterUsage - beforeUsage;

                log(`ðŸ“Š After user test - Usage: ${afterUsage} (Increase: ${increase})`, increase > 0 ? 'success' : 'error');

                return {
                    before: beforeUsage,
                    after: afterUsage,
                    increase: increase,
                    success: increase > 0
                };

            } catch (error) {
                log(`âŒ User coupon test failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function testGuestCoupon() {
            try {
                log('\nðŸ‘» Testing GUEST coupon application...', 'info');
                
                // Get initial usage
                const beforeData = await getCouponUsage();
                const beforeUsage = beforeData.timesUsed;
                log(`ðŸ“Š Before guest test - Usage: ${beforeUsage}`, 'info');

                // Create guest order with coupon
                log('ðŸ’³ Creating guest order with coupon...', 'info');
                const guestOrderData = {
                    clientFullName: 'Guest User',
                    city: 'Guest City',
                    address: '456 Guest Street',
                    phoneNumber: '0987654321',
                    email: 'guest@example.com',
                    cartItems: [{
                        productId: testProductId,
                        quantity: 1
                    }],
                    couponCode: getTestCouponCode()
                };

                const orderResponse = await apiService.post('/orders/guest', guestOrderData);
                log('âœ… Guest order created!', 'success', `Order ID: ${orderResponse.data.id}`);

                // Wait and check usage
                await new Promise(resolve => setTimeout(resolve, 2000));
                const afterData = await getCouponUsage();
                const afterUsage = afterData.timesUsed;
                const increase = afterUsage - beforeUsage;

                log(`ðŸ“Š After guest test - Usage: ${afterUsage} (Increase: ${increase})`, increase > 0 ? 'success' : 'error');

                return {
                    before: beforeUsage,
                    after: afterUsage,
                    increase: increase,
                    success: increase > 0
                };

            } catch (error) {
                log(`âŒ Guest coupon test failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        async function runCompleteTest() {
            clearResults();
            
            try {
                log('ðŸŽ¯ Starting complete user vs guest coupon test...', 'info');
                
                // Step 1: Login as admin
                const adminLogin = await loginAsAdmin();
                if (!adminLogin) return;

                // Step 2: Setup test data
                log('\nðŸ”§ Setting up test data...', 'info');
                const couponCreated = await createTestCoupon();
                if (!couponCreated) {
                    log('âš ï¸ Using existing coupon...', 'warning');
                }

                const productFound = await getTestProduct();
                if (!productFound) return;

                // Get initial usage count
                const initialData = await getCouponUsage();
                initialUsageCount = initialData.timesUsed;
                log(`ðŸ“Š Initial usage count: ${initialUsageCount}`, 'info');

                // Step 3: Test user coupon
                const userResult = await testUserCoupon();

                // Step 4: Test guest coupon
                const guestResult = await testGuestCoupon();

                // Step 5: Final analysis
                log('\nðŸŽ¯ FINAL ANALYSIS:', 'info');
                
                const userSuccess = userResult.success;
                const guestSuccess = guestResult.success;
                
                log('ðŸ“Š Test Results Summary:', 'info',
                    `Initial Usage: ${initialUsageCount}\n` +
                    `User Test: ${userSuccess ? 'PASSED' : 'FAILED'} (${userResult.increase || 0} increase)\n` +
                    `Guest Test: ${guestSuccess ? 'PASSED' : 'FAILED'} (${guestResult.increase || 0} increase)\n` +
                    `Total Increase: ${(userResult.increase || 0) + (guestResult.increase || 0)}`);

                if (userSuccess && guestSuccess) {
                    log('ðŸŽ‰ SUCCESS: Both user and guest coupon applications work!', 'success');
                } else if (userSuccess && !guestSuccess) {
                    log('âš ï¸ PARTIAL SUCCESS: User coupons work, but guest coupons do not!', 'warning');
                    log('ðŸ”§ This means the createGuestOrder method needs the coupon processing logic.', 'critical');
                } else if (!userSuccess && guestSuccess) {
                    log('âš ï¸ PARTIAL SUCCESS: Guest coupons work, but user coupons do not!', 'warning');
                } else {
                    log('âŒ FAILURE: Neither user nor guest coupon applications work!', 'critical');
                }

                // Step 6: Recommendations
                log('\nðŸ’¡ RECOMMENDATIONS:', 'info');
                if (!guestSuccess) {
                    log('1. ðŸš¨ URGENT: Fix createGuestOrder method to process coupons', 'critical');
                    log('2. Add coupon validation and usage tracking to guest orders', 'critical');
                    log('3. Test again after applying the fix', 'info');
                } else {
                    log('1. âœ… Both user and guest coupon applications are working!', 'success');
                    log('2. Check the admin dashboard to verify analytics update', 'info');
                    log('3. Test with real frontend order creation', 'info');
                }

            } catch (error) {
                log(`âŒ Complete test failed: ${error.message}`, 'error');
            }
        }

        async function checkCurrentStatus() {
            try {
                log('ðŸ“Š Checking current status...', 'info');
                
                const usageData = await getCouponUsage();
                log('ðŸ“Š Current Coupon Status:', 'success', 
                    `Coupon: ${getTestCouponCode()}\n` +
                    `Current Usage: ${usageData.timesUsed}\n` +
                    `Usage Limit: ${usageData.usageLimit}\n` +
                    `Details: ${JSON.stringify(usageData.details, null, 2)}`);
                
            } catch (error) {
                log(`âŒ Status check failed: ${error.message}`, 'error');
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Auto-start on page load
        window.addEventListener('load', () => {
            log('ðŸ‘¥ User vs Guest Test System Ready!', 'info', 
                'This test verifies that both authenticated users and guest users can apply coupons.\n' +
                'Make sure your backend is running on localhost:8082\n' +
                'Click "Run Complete Test" to start the comprehensive test.');
        });
    </script>
</body>
</html>
