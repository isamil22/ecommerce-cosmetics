<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Final Coupon Usage Verification Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .test-section h3 {
            color: #333;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            margin: 10px 5px;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.pending { background: #ffc107; color: #000; }
        .status.running { background: #17a2b8; color: #fff; }
        .status.success { background: #28a745; color: #fff; }
        .status.error { background: #dc3545; color: #fff; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
        .test-step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #ddd;
            background: #f8f9fa;
        }
        .test-step.active {
            border-left-color: #17a2b8;
            background: #e7f3ff;
        }
        .test-step.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .test-step.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Final Coupon Usage Verification Test</h1>
            <p>Comprehensive test to verify coupon usage tracking works for both authenticated and guest users</p>
        </div>

        <div class="test-section">
            <h3>üîß Test Configuration</h3>
            <div class="form-group">
                <label for="baseUrl">Backend URL:</label>
                <input type="text" id="baseUrl" value="http://localhost:8080" placeholder="http://localhost:8080">
            </div>
            <div class="form-group">
                <label for="adminEmail">Admin Email:</label>
                <input type="email" id="adminEmail" value="admin@example.com" placeholder="admin@example.com">
            </div>
            <div class="form-group">
                <label for="adminPassword">Admin Password:</label>
                <input type="password" id="adminPassword" value="admin123" placeholder="admin123">
            </div>
            <div class="form-group">
                <label for="userEmail">Test User Email:</label>
                <input type="email" id="userEmail" value="user@example.com" placeholder="user@example.com">
            </div>
            <div class="form-group">
                <label for="userPassword">Test User Password:</label>
                <input type="password" id="userPassword" value="user123" placeholder="user123">
            </div>
            <div class="form-group">
                <label for="couponCode">Test Coupon Code:</label>
                <input type="text" id="couponCode" value="SAVE10" placeholder="SAVE10">
            </div>
        </div>

        <div class="test-section">
            <h3>üìä Test Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText">Ready to start test...</div>
        </div>

        <div class="test-section">
            <h3>üß™ Test Steps</h3>
            <div id="testSteps">
                <div class="test-step" id="step1">
                    <strong>Step 1:</strong> Initialize test environment and get initial coupon data
                </div>
                <div class="test-step" id="step2">
                    <strong>Step 2:</strong> Test authenticated user coupon application
                </div>
                <div class="test-step" id="step3">
                    <strong>Step 3:</strong> Test guest user coupon application
                </div>
                <div class="test-step" id="step4">
                    <strong>Step 4:</strong> Verify usage count increases in admin dashboard
                </div>
                <div class="test-step" id="step5">
                    <strong>Step 5:</strong> Generate final test report
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>üéÆ Test Controls</h3>
            <button onclick="runCompleteTest()" id="runTestBtn">üöÄ Run Complete Test</button>
            <button onclick="clearResults()" id="clearBtn">üóëÔ∏è Clear Results</button>
        </div>

        <div class="test-section">
            <h3>üìã Test Results</h3>
            <div id="testResults" class="result info">Test results will appear here...</div>
        </div>
    </div>

    <script>
        let testResults = [];
        let currentStep = 0;
        let totalSteps = 5;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            testResults.push({ message: logMessage, type });
            
            const resultDiv = document.getElementById('testResults');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            resultDiv.innerHTML += `<div class="${className}">${logMessage}</div>`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        function updateProgress(step, status) {
            const stepElement = document.getElementById(`step${step}`);
            stepElement.className = `test-step ${status}`;
            
            const progress = (step / totalSteps) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `Step ${step}/${totalSteps} - ${status.toUpperCase()}`;
        }

        function clearResults() {
            testResults = [];
            document.getElementById('testResults').innerHTML = 'Test results will appear here...';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = 'Ready to start test...';
            
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`step${i}`).className = 'test-step';
            }
        }

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                throw new Error(`Request failed: ${error.message}`);
            }
        }

        async function runCompleteTest() {
            const runBtn = document.getElementById('runTestBtn');
            runBtn.disabled = true;
            runBtn.textContent = 'üîÑ Running Test...';
            
            clearResults();
            
            try {
                await testStep1_Initialize();
                await testStep2_AuthenticatedUser();
                await testStep3_GuestUser();
                await testStep4_VerifyUsage();
                await testStep5_GenerateReport();
                
                log('üéâ All tests completed successfully!', 'success');
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'üöÄ Run Complete Test';
            }
        }

        async function testStep1_Initialize() {
            updateProgress(1, 'running');
            log('Step 1: Initializing test environment...', 'info');
            
            const baseUrl = document.getElementById('baseUrl').value;
            const couponCode = document.getElementById('couponCode').value;
            
            try {
                // Get initial coupon data
                const coupons = await makeRequest(`${baseUrl}/api/coupons`);
                const testCoupon = coupons.find(c => c.code === couponCode);
                
                if (!testCoupon) {
                    throw new Error(`Test coupon '${couponCode}' not found. Please create it first.`);
                }
                
                window.testData = {
                    baseUrl,
                    couponCode,
                    initialUsage: testCoupon.timesUsed || 0,
                    couponId: testCoupon.id
                };
                
                log(`‚úÖ Found test coupon: ${testCoupon.name} (Initial usage: ${window.testData.initialUsage})`, 'success');
                updateProgress(1, 'success');
            } catch (error) {
                log(`‚ùå Step 1 failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function testStep2_AuthenticatedUser() {
            updateProgress(2, 'running');
            log('Step 2: Testing authenticated user coupon application...', 'info');
            
            try {
                const { baseUrl, couponCode } = window.testData;
                const userEmail = document.getElementById('userEmail').value;
                const userPassword = document.getElementById('userPassword').value;
                
                // Login as user
                const loginResponse = await makeRequest(`${baseUrl}/api/auth/login`, {
                    method: 'POST',
                    body: JSON.stringify({
                        email: userEmail,
                        password: userPassword
                    })
                });
                
                const userToken = loginResponse.token;
                log(`‚úÖ Logged in as user: ${userEmail}`, 'success');
                
                // Create order with coupon
                const orderData = {
                    shippingAddress: {
                        street: "123 Test St",
                        city: "Test City",
                        state: "TS",
                        zipCode: "12345",
                        country: "Test Country"
                    },
                    paymentMethod: "CREDIT_CARD",
                    couponCode: couponCode,
                    cartItems: [
                        {
                            productId: 1,
                            quantity: 2
                        }
                    ]
                };
                
                const orderResponse = await makeRequest(`${baseUrl}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(orderData)
                });
                
                log(`‚úÖ Created order with coupon: Order #${orderResponse.id}`, 'success');
                window.testData.authenticatedOrderId = orderResponse.id;
                updateProgress(2, 'success');
            } catch (error) {
                log(`‚ùå Step 2 failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function testStep3_GuestUser() {
            updateProgress(3, 'running');
            log('Step 3: Testing guest user coupon application...', 'info');
            
            try {
                const { baseUrl, couponCode } = window.testData;
                
                // Create guest order with coupon
                const guestOrderData = {
                    customerInfo: {
                        firstName: "Guest",
                        lastName: "User",
                        email: "guest@example.com",
                        phone: "123-456-7890"
                    },
                    shippingAddress: {
                        street: "456 Guest Ave",
                        city: "Guest City",
                        state: "GC",
                        zipCode: "54321",
                        country: "Guest Country"
                    },
                    paymentMethod: "CREDIT_CARD",
                    couponCode: couponCode,
                    cartItems: [
                        {
                            productId: 1,
                            quantity: 1
                        }
                    ]
                };
                
                const guestOrderResponse = await makeRequest(`${baseUrl}/api/orders/guest`, {
                    method: 'POST',
                    body: JSON.stringify(guestOrderData)
                });
                
                log(`‚úÖ Created guest order with coupon: Order #${guestOrderResponse.id}`, 'success');
                window.testData.guestOrderId = guestOrderResponse.id;
                updateProgress(3, 'success');
            } catch (error) {
                log(`‚ùå Step 3 failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function testStep4_VerifyUsage() {
            updateProgress(4, 'running');
            log('Step 4: Verifying usage count increased in admin dashboard...', 'info');
            
            try {
                const { baseUrl, couponCode, initialUsage } = window.testData;
                
                // Get updated coupon data
                const coupons = await makeRequest(`${baseUrl}/api/coupons`);
                const testCoupon = coupons.find(c => c.code === couponCode);
                const currentUsage = testCoupon.timesUsed || 0;
                const usageIncrease = currentUsage - initialUsage;
                
                log(`üìä Usage Statistics:`, 'info');
                log(`   Initial usage: ${initialUsage}`, 'info');
                log(`   Current usage: ${currentUsage}`, 'info');
                log(`   Usage increase: +${usageIncrease}`, 'info');
                
                if (usageIncrease >= 2) {
                    log(`‚úÖ SUCCESS: Usage count increased by ${usageIncrease} (expected: +2)`, 'success');
                    log(`   ‚úÖ Authenticated user order tracked`, 'success');
                    log(`   ‚úÖ Guest user order tracked`, 'success');
                } else if (usageIncrease === 1) {
                    log(`‚ö†Ô∏è PARTIAL SUCCESS: Usage count increased by ${usageIncrease} (expected: +2)`, 'warning');
                    log(`   ‚ö†Ô∏è Only one order was tracked properly`, 'warning');
                } else {
                    log(`‚ùå FAILURE: Usage count did not increase properly`, 'error');
                    log(`   ‚ùå Expected +2, got +${usageIncrease}`, 'error');
                }
                
                window.testData.finalUsage = currentUsage;
                window.testData.usageIncrease = usageIncrease;
                updateProgress(4, usageIncrease >= 2 ? 'success' : 'error');
            } catch (error) {
                log(`‚ùå Step 4 failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function testStep5_GenerateReport() {
            updateProgress(5, 'running');
            log('Step 5: Generating final test report...', 'info');
            
            try {
                const { initialUsage, finalUsage, usageIncrease, authenticatedOrderId, guestOrderId } = window.testData;
                
                log('', 'info');
                log('='.repeat(60), 'info');
                log('üìã FINAL TEST REPORT', 'info');
                log('='.repeat(60), 'info');
                log('', 'info');
                
                log(`üéØ Test Objective: Verify coupon usage tracking for both user types`, 'info');
                log('', 'info');
                
                log(`üìä Usage Statistics:`, 'info');
                log(`   ‚Ä¢ Initial usage count: ${initialUsage}`, 'info');
                log(`   ‚Ä¢ Final usage count: ${finalUsage}`, 'info');
                log(`   ‚Ä¢ Total increase: +${usageIncrease}`, 'info');
                log('', 'info');
                
                log(`üìù Order Details:`, 'info');
                log(`   ‚Ä¢ Authenticated user order: #${authenticatedOrderId}`, 'info');
                log(`   ‚Ä¢ Guest user order: #${guestOrderId}`, 'info');
                log('', 'info');
                
                if (usageIncrease >= 2) {
                    log(`‚úÖ TEST RESULT: PASSED`, 'success');
                    log(`   ‚úÖ Both authenticated and guest users can apply coupons`, 'success');
                    log(`   ‚úÖ Usage count is properly tracked for both user types`, 'success');
                    log(`   ‚úÖ Admin dashboard will show correct analytics`, 'success');
                } else if (usageIncrease === 1) {
                    log(`‚ö†Ô∏è TEST RESULT: PARTIAL PASS`, 'warning');
                    log(`   ‚ö†Ô∏è Only one user type is working properly`, 'warning');
                    log(`   ‚ö†Ô∏è Check the implementation for the failing user type`, 'warning');
                } else {
                    log(`‚ùå TEST RESULT: FAILED`, 'error');
                    log(`   ‚ùå Coupon usage tracking is not working properly`, 'error');
                    log(`   ‚ùå Check the OrderService implementation`, 'error');
                }
                
                log('', 'info');
                log('='.repeat(60), 'info');
                
                updateProgress(5, 'success');
            } catch (error) {
                log(`‚ùå Step 5 failed: ${error.message}`, 'error');
                throw error;
            }
        }
    </script>
</body>
</html>
