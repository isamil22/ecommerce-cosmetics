<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Announcement Control Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .disabled { background: #6c757d; }
        .enabled { background: #28a745; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Announcement Control Test</h1>
        <p>This page tests if the admin dashboard can control the announcement bar.</p>

        <div class="test-section info">
            <h3>üìã Test Steps</h3>
            <ol>
                <li>Click "Get Current Announcement" to see current settings</li>
                <li>Click "Enable Announcement" to turn it on</li>
                <li>Click "Disable Announcement" to turn it off</li>
                <li>Check the main site to see if changes appear</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üîß API Tests</h3>
            <button onclick="getCurrentAnnouncement()">Get Current Announcement</button>
            <button onclick="enableAnnouncement()" class="enabled">Enable Announcement</button>
            <button onclick="disableAnnouncement()" class="disabled">Disable Announcement</button>
            <button onclick="setCustomAnnouncement()">Set Custom Text</button>
            <div id="api-results"></div>
        </div>

        <div class="test-section">
            <h3>üìä Current Status</h3>
            <div id="current-status">Click "Get Current Announcement" to see status</div>
        </div>

        <div class="test-section">
            <h3>üéØ Expected Behavior</h3>
            <ul>
                <li><strong>Enabled:</strong> Announcement bar should be visible on main site</li>
                <li><strong>Disabled:</strong> Announcement bar should be hidden on main site</li>
                <li><strong>Custom Text:</strong> Should show your custom message</li>
                <li><strong>Real-time:</strong> Changes should appear within 30 seconds</li>
            </ul>
        </div>
    </div>

    <script>
        let currentAnnouncement = null;

        async function getCurrentAnnouncement() {
            const resultsDiv = document.getElementById('api-results');
            const statusDiv = document.getElementById('current-status');
            
            resultsDiv.innerHTML = '<p>Fetching current announcement...</p>';
            
            try {
                const response = await fetch('/api/announcement');
                const data = await response.json();
                currentAnnouncement = data;
                
                resultsDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Current Announcement Retrieved</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
                statusDiv.innerHTML = `
                    <div class="${data.enabled ? 'success' : 'error'}">
                        <h4>Status: ${data.enabled ? 'ENABLED' : 'DISABLED'}</h4>
                        <p><strong>Text:</strong> ${data.text || 'No text set'}</p>
                        <p><strong>Background:</strong> ${data.backgroundColor}</p>
                        <p><strong>Animation:</strong> ${data.animationType}</p>
                        <p><strong>Online Counter:</strong> ${data.showOnlineCounter ? 'Shown' : 'Hidden'}</p>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Failed to fetch announcement</h4>
                        <p>Error: ${error.message}</p>
                        <p>Make sure your backend server is running</p>
                    </div>
                `;
            }
        }

        async function enableAnnouncement() {
            if (!currentAnnouncement) {
                await getCurrentAnnouncement();
            }
            
            const updatedAnnouncement = {
                ...currentAnnouncement,
                enabled: true,
                text: currentAnnouncement.text || "ÿ¥ÿ≠ŸÜ ŸÖÿ¨ÿßŸÜŸä ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ŸÅŸàŸÇ $50 / Free Shipping on Orders Over $50!"
            };
            
            await updateAnnouncement(updatedAnnouncement);
        }

        async function disableAnnouncement() {
            if (!currentAnnouncement) {
                await getCurrentAnnouncement();
            }
            
            const updatedAnnouncement = {
                ...currentAnnouncement,
                enabled: false
            };
            
            await updateAnnouncement(updatedAnnouncement);
        }

        async function setCustomAnnouncement() {
            const customText = prompt("Enter your custom announcement text:");
            if (!customText) return;
            
            if (!currentAnnouncement) {
                await getCurrentAnnouncement();
            }
            
            const updatedAnnouncement = {
                ...currentAnnouncement,
                enabled: true,
                text: customText
            };
            
            await updateAnnouncement(updatedAnnouncement);
        }

        async function updateAnnouncement(announcementData) {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<p>Updating announcement...</p>';
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Not logged in</h4>
                            <p>You need to be logged in as admin to update announcements</p>
                            <p>Please login first, then try again</p>
                        </div>
                    `;
                    return;
                }
                
                const response = await fetch('/api/announcement', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(announcementData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentAnnouncement = data;
                    
                    resultsDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Announcement Updated Successfully!</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                    
                    // Update status
                    const statusDiv = document.getElementById('current-status');
                    statusDiv.innerHTML = `
                        <div class="${data.enabled ? 'success' : 'error'}">
                            <h4>Status: ${data.enabled ? 'ENABLED' : 'DISABLED'}</h4>
                            <p><strong>Text:</strong> ${data.text || 'No text set'}</p>
                            <p><strong>Background:</strong> ${data.backgroundColor}</p>
                            <p><strong>Animation:</strong> ${data.animationType}</p>
                            <p><strong>Online Counter:</strong> ${data.showOnlineCounter ? 'Shown' : 'Hidden'}</p>
                        </div>
                    `;
                    
                    // Show instructions
                    resultsDiv.innerHTML += `
                        <div class="info">
                            <h4>üìù Next Steps:</h4>
                            <p>1. Go to your main site</p>
                            <p>2. The announcement bar should ${data.enabled ? 'appear' : 'disappear'} within 30 seconds</p>
                            <p>3. If it doesn't change, check the browser console for errors</p>
                        </div>
                    `;
                } else {
                    const errorText = await response.text();
                    resultsDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Failed to update announcement</h4>
                            <p>Status: ${response.status}</p>
                            <p>Error: ${errorText}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Failed to update announcement</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Auto-load current status on page load
        window.onload = function() {
            getCurrentAnnouncement();
        };
    </script>
</body>
</html>
